# Analyzing and Searching Logs

Log files are a rich source of information for diagnosing issues, monitoring system activity, and detecting security breaches. However, effectively analyzing and searching through logs requires a good understanding of various command-line tools. This lecture will cover how to use tools like `grep`, `awk`, `sed`, and `journalctl` to analyze and search logs efficiently.

## Introduction to Log Analysis

Log analysis involves searching, filtering, and interpreting log entries to extract valuable information. This is crucial for troubleshooting problems, auditing activities, and ensuring system security.

### Key Tools for Log Analysis

- **`grep`**: Search for patterns in text files.
- **`awk`**: Process and analyze text files based on patterns.
- **`sed`**: Stream editor for filtering and transforming text.
- **`journalctl`**: Query and view logs generated by the `systemd` service.

## Searching Logs with grep

The `grep` command searches through text files for lines that match a given pattern. It is one of the most powerful tools for searching logs.

### Basic Usage

```bash
grep "pattern" filename
```

#### Example: Search for Authentication Failures

```bash
grep "Failed password" /var/log/auth.log
```

### Common Options

- **`-i`**: Ignore case distinctions in patterns and data.
- **`-r`**: Recursively search through directories.
- **`-n`**: Show line numbers with output.
- **`-A`**: Show lines after the matching line.
- **`-B`**: Show lines before the matching line.

#### Example: Search Recursively for a Pattern in /var/log

```bash
grep -r "error" /var/log/
```

### Combining grep with Other Commands

You can combine `grep` with other commands to enhance your search capabilities.

#### Example: Filter logs and count occurrences

```bash
grep "Failed password" /var/log/auth.log | wc -l
```

## Processing Logs with awk

The `awk` command is a powerful text processing tool that allows you to select and manipulate text from log files based on patterns.

### Basic Usage

```bash
awk 'pattern {action}' filename
```

#### Example: Extract IP Addresses from Logs

```bash
awk '/Failed password/ {print $11}' /var/log/auth.log
```

### Common Actions

- **`print $N`**: Print the Nth field of the line.
- **`{sum += $N} END {print sum}`**: Sum up a column of numbers.

#### Example: Summarize Disk Space Usage from Logs

```bash
awk '/disk usage/ {sum += $5} END {print sum}' /var/log/syslog
```

## Editing Logs with sed

The `sed` command is a stream editor that allows you to perform basic text transformations on an input stream (a file or input from a pipeline).

### Basic Usage

```bash
sed 's/old/new/g' filename
```

#### Example: Replace IP Address in Logs

```bash
sed 's/192.168.1.100/REMOVED/g' /var/log/syslog
```

### Common Options

- **`-i`**: Edit files in place (i.e., make changes directly in the file).
- **`-e`**: Add the script to the commands to be executed.

#### Example: Delete Lines Matching a Pattern

```bash
sed '/pattern/d' filename
```

## Using journalctl for systemd Logs

The `journalctl` command is used to query and view logs generated by the `systemd` service. This includes logs from the kernel, init system, and all systemd units.

### Basic Usage

```bash
journalctl
```

### Filtering Logs by Time

#### Example: Show Logs from the Last Hour

```bash
journalctl --since "1 hour ago"
```

#### Example: Show Logs Between Two Dates

```bash
journalctl --since "2023-06-01 00:00:00" --until "2023-06-01 23:59:59"
```

### Filtering Logs by Unit

#### Example: Show Logs for the sshd Service

```bash
journalctl -u sshd
```

### Filtering Logs by Priority

#### Example: Show Only Error Messages

```bash
journalctl -p err
```

### Persistent Logging with journalctl

To ensure logs persist across reboots, you can configure `journalctl` to store logs persistently:

1. Edit the `/etc/systemd/journald.conf` file:
   ```bash
   sudo nano /etc/systemd/journald.conf
   ```
2. Uncomment and set `Storage=persistent`:
   ```bash
   Storage=persistent
   ```
3. Restart the `systemd-journald` service:
   ```bash
   sudo systemctl restart systemd-journald
   ```

## Practical Examples

### Example 1: Search for Critical System Errors with journalctl

```bash
journalctl -p crit
```
- This command shows only critical system errors.

### Example 2: Extract Usernames from Authentication Failures with awk

```bash
awk '/Failed password/ {print $9}' /var/log/auth.log
```
- This extracts the usernames involved in failed SSH login attempts.

### Example 3: Search and Replace Text in Logs with sed

```bash
sed -i 's/192.168.1.100/REDACTED/g' /var/log/syslog
```
- This replaces all instances of a specific IP address with "REDACTED" in the syslog.

## Conclusion

Analyzing and searching through logs is a vital skill for any system administrator. By mastering tools like `grep`, `awk`, `sed`, and `journalctl`, you can efficiently parse, filter, and analyze logs to diagnose issues, monitor activity, and maintain security on your Linux systems.